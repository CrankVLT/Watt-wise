<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WattWise | Calculadora de consumo eléctrico</title>
    
    <!-- PWA Meta Tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WattWise">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Calculadora de consumo eléctrico para dispositivos">
    
    <!-- Libraries (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Utilities ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if (type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.2);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        };

        const formatCLP = (val) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(val);

        // --- Icon Wrapper for CDN ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Sub-Components ---
        const Header = ({ tariff, setActiveTab }) => (
            <header className="flex justify-between items-center p-6 mb-4">
                <div>
                    <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">WattWise</h1>
                    <p className="text-xs text-slate-400 font-mono tracking-wider">CALCULADORA DE COSTO ENERGÉTICO</p>
                </div>
                <button onClick={() => { playSound('click'); setActiveTab('tariff'); }} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-1.5 rounded-full transition-colors text-xs font-semibold text-cyan-400">
                    <Icon name="zap" size={14} /> ${tariff}/kWh
                </button>
            </header>
        );

        const ResultCard = ({ costTotal, days, hours, costPerHour, effectiveWatts, calcMode, monthlyKwh }) => (
            <div className="col-span-12 md:col-span-8 glass-panel rounded-3xl p-6 relative overflow-hidden animate-enter shadow-2xl shadow-cyan-900/20 border-t border-white/10">
                <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="coins" size={120} /></div>
                <h2 className="text-slate-400 text-sm font-medium mb-1 uppercase tracking-wide">Costo Estimado</h2>
                <div className="flex flex-col md:flex-row md:items-end gap-2 mb-4">
                    <span className="text-5xl md:text-6xl font-bold text-white tracking-tight">{formatCLP(costTotal)}</span>
                    <span className="text-slate-400 mb-2 text-sm">/ en {days} días {calcMode !== 'kwh_label' ? `(${hours}h diarias)` : '(Ciclo Continuo)'}</span>
                </div>
                <div className="flex gap-4 text-sm border-t border-white/5 pt-4 mt-2">
                    <div className="flex flex-col">
                        <span className="text-slate-500 text-xs">{calcMode === 'kwh_label' ? 'Costo Diario Promedio' : 'Costo por Hora'}</span>
                        <span className="text-cyan-300 font-mono">{calcMode === 'kwh_label' ? formatCLP(costPerHour * 24) : formatCLP(costPerHour)}</span>
                    </div>
                    <div className="flex flex-col">
                        <span className="text-slate-500 text-xs">Consumo Mensual Estimado</span>
                        <span className="text-cyan-300 font-mono">{monthlyKwh.toFixed(1)} kWh</span>
                    </div>
                </div>
            </div>
        );

        const InputCard = ({ calcMode, setCalcMode, watts, setWatts, volts, setVolts, amps, setAmps, kwhLabel, setKwhLabel, hours, setHours, days, setDays }) => (
            <div className="col-span-12 md:col-span-4 glass-panel rounded-3xl p-6 animate-enter" style={{animationDelay: '0.1s'}}>
                <div className="flex gap-1 mb-6 bg-slate-900/50 p-1 rounded-xl">
                    <button onClick={() => { playSound('click'); setCalcMode('watts'); }} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${calcMode === 'watts' ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>WATTS</button>
                    <button onClick={() => { playSound('click'); setCalcMode('va'); }} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${calcMode === 'va' ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>V × A</button>
                    <button onClick={() => { playSound('click'); setCalcMode('kwh_label'); }} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${calcMode === 'kwh_label' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>ETIQUETA</button>
                </div>

                {calcMode === 'watts' && (
                    <div className="mb-4"><label className="text-xs text-slate-400 block mb-2">Potencia (W)</label><div className="relative"><input type="number" value={watts} onChange={(e) => setWatts(Number(e.target.value))} className="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-4 text-2xl font-mono focus:outline-none focus:border-cyan-500 transition-colors" /><span className="absolute right-4 top-5 text-slate-500 text-sm font-bold">W</span></div></div>
                )}
                {calcMode === 'va' && (
                    <div className="flex gap-2 mb-4"><div className="flex-1"><label className="text-xs text-slate-400 block mb-2">Volts</label><input type="number" value={volts} onChange={(e) => setVolts(Number(e.target.value))} className="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 text-lg font-mono focus:outline-none focus:border-cyan-500" /></div><div className="flex-1"><label className="text-xs text-slate-400 block mb-2">Amps</label><input type="number" value={amps} onChange={(e) => setAmps(Number(e.target.value))} className="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 text-lg font-mono focus:outline-none focus:border-cyan-500" /></div></div>
                )}
                {calcMode === 'kwh_label' && (
                    <div className="mb-4"><label className="text-xs text-emerald-400 block mb-2 font-bold flex items-center gap-2"><Icon name="tag" size={14}/> Consumo Mensual (Etiqueta)</label><div className="relative"><input type="number" value={kwhLabel} onChange={(e) => setKwhLabel(Number(e.target.value))} className="w-full bg-slate-800 border border-emerald-500/50 text-white rounded-xl p-4 text-2xl font-mono focus:outline-none focus:border-emerald-500 transition-colors" /><span className="absolute right-4 top-5 text-emerald-500 text-sm font-bold">kWh/mes</span></div><p className="text-[10px] text-slate-500 mt-2 leading-tight">Ingresa el valor exacto que aparece en la etiqueta de eficiencia energética.</p></div>
                )}

                <div className="grid grid-cols-2 gap-2">
                    {calcMode !== 'kwh_label' ? (
                        <div><label className="text-xs text-slate-400 block mb-2">Horas / Día</label><input type="number" value={hours} onChange={(e) => setHours(Number(e.target.value))} className="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl p-3 text-center font-mono focus:outline-none focus:border-cyan-500" /></div>
                    ) : (
                        <div className="opacity-50 grayscale"><label className="text-xs text-slate-500 block mb-2">Horas / Día</label><div className="w-full bg-slate-900/30 border border-slate-800 text-slate-600 rounded-xl p-3 text-center font-mono text-sm">Auto (24h)</div></div>
                    )}
                    <div><label className="text-xs text-slate-400 block mb-2">Total Días</label><input type="number" value={days} onChange={(e) => setDays(Number(e.target.value))} className="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl p-3 text-center font-mono focus:outline-none focus:border-cyan-500" /></div>
                </div>
            </div>
        );

        const DeviceGrid = ({ handlePreset }) => {
            const devices = [
                { name: 'PS5 (Juego)', watts: 200, icon: 'gamepad-2' },
                { name: 'PS5 (Reposo)', watts: 5, icon: 'moon' },
                { name: 'PS4 Pro', watts: 160, icon: 'gamepad-2' },
                { name: 'Notebook', watts: 45, icon: 'laptop' },
                { name: 'Hervidor', watts: 2000, icon: 'coffee' },
                { name: 'TV 55"', watts: 110, icon: 'tv' },
                { name: 'Refrigerador', watts: 24.54, icon: 'snowflake' },
                { name: 'Microondas', watts: 1200, icon: 'microwave' },
                { name: 'Lavadora', watts: 500, icon: 'waves' },
                { name: 'Estufa Elec.', watts: 1500, icon: 'flame' },
                { name: 'Ventilador', watts: 60, icon: 'fan' },
                { name: 'Ampolleta LED', watts: 9, icon: 'lightbulb' },
                { name: 'Router WiFi', watts: 10, icon: 'wifi' }
            ];
            
            return (
                <div className="col-span-12 animate-enter" style={{animationDelay: '0.2s'}}>
                    <h3 className="text-sm font-bold text-slate-500 mb-3 ml-1">PRESETS RÁPIDOS</h3>
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
                        {devices.map((dev, i) => (
                            <button key={i} onClick={() => handlePreset(dev.watts)} className="group glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-700/50 hover:border-cyan-500/50 transition-all active:scale-95">
                                <div className="text-cyan-400 group-hover:text-cyan-300 transition-colors group-hover:scale-110 duration-300"><Icon name={dev.icon} size={24} /></div>
                                <span className="text-[10px] font-medium text-slate-300 text-center leading-tight">{dev.name}</span>
                                <span className="text-[10px] font-mono text-slate-500">{dev.watts}W</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const Navigation = ({ activeTab, setActiveTab }) => (
            <nav className="fixed bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-lg border-t border-white/10 p-2 z-50 safe-area-pb">
                <div className="flex justify-around max-w-md mx-auto">
                    <button onClick={() => {playSound('click'); setActiveTab('calculator')}} className={`flex flex-col items-center p-2 rounded-lg w-16 transition-colors ${activeTab === 'calculator' ? 'text-cyan-400' : 'text-slate-500'}`}><Icon name="calculator" size={20} /><span className="text-[10px] mt-1 font-medium">Calculadora</span></button>
                    <button onClick={() => {playSound('click'); setActiveTab('tariff')}} className={`flex flex-col items-center p-2 rounded-lg w-16 transition-colors ${activeTab === 'tariff' ? 'text-cyan-400' : 'text-slate-500'}`}><Icon name="settings-2" size={20} /><span className="text-[10px] mt-1 font-medium">Tarifa</span></button>
                    <button onClick={() => {playSound('click'); setActiveTab('help')}} className={`flex flex-col items-center p-2 rounded-lg w-16 transition-colors ${activeTab === 'help' ? 'text-cyan-400' : 'text-slate-500'}`}><Icon name="book-open" size={20} /><span className="text-[10px] mt-1 font-medium">Ayuda</span></button>
                </div>
            </nav>
        );

        const TariffView = ({ tariff, setTariff }) => (
            <div className="max-w-2xl mx-auto pb-24 animate-enter">
                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="zap" className="text-yellow-400" /> Configuración de Tarifa</h2>
                
                {/* FIX: Clases responsivas aplicadas para móvil */}
                <div className="glass-panel rounded-3xl p-4 md:p-6 mb-6">
                    <label className="text-sm text-slate-400 block mb-3">Costo por kWh (CLP)</label>
                    <div className="flex gap-2 md:gap-4 items-center">
                        <input type="number" value={tariff} onChange={(e) => setTariff(Number(e.target.value))} className="flex-1 bg-slate-800 border border-slate-600 text-white rounded-xl p-3 md:p-4 text-xl md:text-2xl font-mono focus:outline-none focus:border-cyan-500" />
                        <button onClick={() => {setTariff(230); playSound('success');}} className="bg-cyan-900/30 text-cyan-400 px-3 md:px-4 py-3 md:py-4 rounded-xl font-bold text-xs md:text-sm hover:bg-cyan-900/50 border border-cyan-800">RESET</button>
                    </div>
                    <p className="text-xs text-slate-500 mt-3">* Calculado basado en tu boleta reciente (Costos Variables / Consumo).</p>
                </div>

                <h3 className="text-sm font-bold text-slate-500 mb-3 uppercase">Tarifas de Referencia (Aprox.)</h3>
                <div className="space-y-2">
                    <div className="bg-slate-800/50 p-4 rounded-xl flex justify-between items-center border border-white/5"><div><div className="font-bold text-white">Residencial Promedio</div><div className="text-xs text-slate-400">Santiago (BT1)</div></div><div className="font-mono text-cyan-300">$180 - $240</div></div>
                    <div className="bg-slate-800/50 p-4 rounded-xl flex justify-between items-center border border-white/5"><div><div className="font-bold text-white">Sobreconsumo</div><div className="text-xs text-slate-400">Invierno</div></div><div className="font-mono text-red-300">~$300+</div></div>
                </div>
            </div>
        );

        const HelpView = () => (
            <div className="max-w-2xl mx-auto pb-24 animate-enter space-y-6">
                <div className="glass-panel rounded-3xl p-6 border-l-4 border-cyan-500">
                    <h2 className="text-lg font-bold text-white mb-2 flex items-center gap-2">Primeros Principios</h2>
                    <p className="text-sm text-slate-300 leading-relaxed">Gordito, no te confíes del total de la boleta. Para estimar ahorro o gasto, solo importa el <strong className="text-cyan-400">Costo Variable Unitario</strong>.</p>
                </div>
                <div className="glass-panel rounded-3xl p-6">
                    <h3 className="text-md font-bold text-white mb-4 flex items-center gap-2"><Icon name="search" size={18} /> ¿Dónde encontrar los datos?</h3>
                    <ul className="space-y-4">
                        <li className="flex gap-3"><div className="bg-slate-800 p-2 rounded-lg h-fit"><Icon name="file-text" size={16} className="text-yellow-400"/></div><div><strong className="text-white text-sm">En tu Boleta</strong><p className="text-xs text-slate-400 mt-1">Suma "Electricidad Consumida" + "Transporte". Divide esa suma por el total de kWh consumidos.</p></div></li>
                        <li className="flex gap-3"><div className="bg-slate-800 p-2 rounded-lg h-fit"><Icon name="tag" size={16} className="text-green-400"/></div><div><strong className="text-white text-sm">En el Dispositivo</strong><p className="text-xs text-slate-400 mt-1">Busca la etiqueta "INPUT" o "ENTRADA".</p></div></li>
                        <li className="flex gap-3"><div className="bg-slate-800 p-2 rounded-lg h-fit"><Icon name="snowflake" size={16} className="text-emerald-400"/></div><div><strong className="text-white text-sm">Refrigeradores</strong><p className="text-xs text-slate-400 mt-1">Usa la pestaña "ETIQUETA" y pon el valor mensual exacto (ej: 17.67).</p></div></li>
                    </ul>
                </div>
            </div>
        );

        const App = () => {
            const [watts, setWatts] = useState(200);
            const [hours, setHours] = useState(2);
            const [days, setDays] = useState(30);
            const [tariff, setTariff] = useState(230);
            const [volts, setVolts] = useState(220);
            const [amps, setAmps] = useState(1);
            const [kwhLabel, setKwhLabel] = useState(17.67);
            const [calcMode, setCalcMode] = useState('watts');
            const [activeTab, setActiveTab] = useState('calculator');
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isInstallable, setIsInstallable] = useState(false);

            // --- LOGICA PWA INTELIGENTE (INYECCIÓN) ---
            useEffect(() => {
                // 1. Generar Manifesto Dinámico
                const iconSVG = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="none"><rect width="512" height="512" rx="128" fill="#0f172a"/><path d="M256 112L160 288H288L256 400L352 224H224L256 112Z" fill="#22d3ee" stroke="#fff" stroke-width="20"/></svg>`);
                const manifest = {
                    name: "WattWise",
                    short_name: "WattWise",
                    description: "Calculadora de consumo eléctrico para tacaños",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#0f172a",
                    theme_color: "#0f172a",
                    orientation: "portrait",
                    icons: [{ src: `data:image/svg+xml;charset=utf-8,${iconSVG}`, sizes: "512x512", type: "image/svg+xml" }]
                };
                
                const stringManifest = JSON.stringify(manifest);
                const blob = new Blob([stringManifest], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                
                let link = document.querySelector('#dynamic-manifest');
                if (!link) {
                    link = document.createElement('link');
                    link.id = 'dynamic-manifest';
                    link.rel = 'manifest';
                    document.head.appendChild(link);
                }
                link.href = manifestURL;

                // 2. Escuchar evento de instalación (Android)
                const handleInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setIsInstallable(true);
                };

                window.addEventListener('beforeinstallprompt', handleInstallPrompt);
                return () => window.removeEventListener('beforeinstallprompt', handleInstallPrompt);
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setIsInstallable(false);
                }
                setDeferredPrompt(null);
            };

            let dailyKwh = 0;
            let activeWatts = 0;

            if (calcMode === 'kwh_label') {
                dailyKwh = kwhLabel / 30;
                activeWatts = 0;
            } else {
                activeWatts = calcMode === 'watts' ? watts : (volts * amps);
                dailyKwh = (activeWatts / 1000) * hours;
            }

            const costTotal = dailyKwh * days * tariff;
            const costPerHour = calcMode === 'kwh_label' ? (dailyKwh * tariff) / 24 : ((activeWatts / 1000) * tariff);
            const monthlyKwhDisplay = dailyKwh * 30;

            const handlePreset = (presetWatts) => { playSound('click'); setCalcMode('watts'); setWatts(presetWatts); };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto font-sans">
                    <Header tariff={tariff} setActiveTab={setActiveTab} />
                    <main>
                        {activeTab === 'calculator' && (
                            <div className="grid grid-cols-12 gap-4 pb-24">
                                <ResultCard costTotal={costTotal} days={days} hours={hours} costPerHour={costPerHour} effectiveWatts={activeWatts} calcMode={calcMode} monthlyKwh={monthlyKwhDisplay} />
                                <InputCard calcMode={calcMode} setCalcMode={setCalcMode} watts={watts} setWatts={setWatts} volts={volts} setVolts={setVolts} amps={amps} setAmps={setAmps} kwhLabel={kwhLabel} setKwhLabel={setKwhLabel} hours={hours} setHours={setHours} days={days} setDays={setDays} />
                                <DeviceGrid handlePreset={handlePreset} />
                            </div>
                        )}
                        {activeTab === 'tariff' && <TariffView tariff={tariff} setTariff={setTariff} />}
                        {activeTab === 'help' && <HelpView />}
                    </main>
                    
                    {/* Botón de Instalación Inteligente */}
                    {isInstallable && (
                        <div className="fixed bottom-20 left-4 right-4 bg-cyan-900 text-white p-4 rounded-xl shadow-2xl border border-cyan-500/30 flex justify-between items-center animate-enter z-40 md:hidden">
                            <div className="text-xs"><p className="font-bold">Instalar App</p><p className="text-cyan-200">Úsala sin internet y a pantalla completa.</p></div>
                            <div className="flex gap-3">
                                <button onClick={() => setIsInstallable(false)} className="text-cyan-400 hover:text-white text-xs font-bold">AHORA NO</button>
                                <button onClick={handleInstallClick} className="bg-cyan-500 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-lg">INSTALAR</button>
                            </div>
                        </div>
                    )}
                    
                    <Navigation activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>





